#:kivy 2.3.0

# --- M√ÄU S·∫ÆC ---
#:set c_bg (0.05, 0.05, 0.1, 1)
#:set c_primary (0, 0.8, 1, 1)
#:set c_card (0.15, 0.15, 0.25, 1)
#:set c_btn_press (0, 0.5, 0.7, 1)

# --- STYLE N√öT B·∫§M ---
<ModernButton@Button>:
    background_normal: ''
    background_color: (0,0,0,0)
    canvas.before:
        Color:
            rgba: c_primary if self.state == 'normal' else c_btn_press
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10,]
    bold: True
    color: (1,1,1,1)
    font_size: '24sp'
    # üëá TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ T·∫†O VI·ªÄN CH·ªÆ (Gi√∫p ch·ªØ n·ªïi l√™n tr√™n m·ªçi n·ªÅn):
    outline_color: (0, 0, 0, 0.5)  # Vi·ªÅn ƒëen m·ªù
    outline_width: 2               # ƒê·ªô d√†y vi·ªÅn

# --- STYLE CARD (ƒê√£ n√¢ng c·∫•p ƒë·ªÉ c√≥ th·ªÉ ƒë·ªïi m√†u) ---
<DashboardCard@ButtonBehavior+BoxLayout>:
    title: ''   
    desc: ''
    # TH√äM D√íNG N√ÄY: Thi·∫øt l·∫≠p gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† m√†u c_card c≈©
    card_color: (0.15, 0.15, 0.25, 1) 
    
    orientation: 'vertical'
    padding: 20
    spacing: 10
    canvas.before:
        Color:  
            # S·ª¨A D√íNG N√ÄY: Thay c_card b·∫±ng self.card_color
            rgba: self.card_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [15,]
            
    # C√°c ph·∫ßn Label b√™n d∆∞·ªõi gi·ªØ nguy√™n kh√¥ng ƒë·ªïi...
    Label:
        text: root.title
        font_size: '22sp'
        bold: True
        color: c_primary
        size_hint_y: 0.3
    Label:
        text: root.desc
        font_size: '14sp'
        color: (0.7, 0.7, 0.7, 1)
        size_hint_y: 0.7
        halign: 'center'

ScreenManager:
    HomeScreen:
    SecurityScreen:
    TutorScreen:
    ElderlyScreen:
# ================= HOME SCREEN =================
<HomeScreen>:
    name: 'home'
    canvas.before:
        Color:
            rgba: c_bg
        Rectangle:
            pos: self.pos
            size: self.size
    
    # 1. L·ªöP CH√çNH: BONG B√ìNG V√Ä TR·∫†NG TH√ÅI
    FloatLayout:
        # Bong b√≥ng 3D n·∫±m ch√≠nh gi·ªØa
        Bubble3D:
            id: bubble_widget
            pos_hint: {'center_x': 0.5, 'center_y': 0.55}
            size_hint: (None, None)
            size: (200, 200)

        # Label hi·ªÉn th·ªã tr·∫°ng th√°i gi·ªçng n√≥i (nh·ªè b√™n d∆∞·ªõi bong b√≥ng)
        Label:
            id: lbl_status
            text: "ƒêang l·∫Øng nghe..."
            font_size: '18sp'
            color: (0.6, 0.8, 1, 1)
            pos_hint: {'center_x': 0.5, 'y': 0.25}
            size_hint: (1, 0.1)
            halign: 'center'

        # N√∫t M·ªü Menu (G√≥c tr√™n ph·∫£i)
        Button:
            text: "MENU"
            font_size: '20sp'
            size_hint: (None, None)
            size: (100, 50)
            pos_hint: {'right': 0.95, 'top': 0.95}
            background_color: (0.2, 0.2, 0.3, 1)
            on_release: root.toggle_menu()

    # 2. L·ªöP PH·ª¶ MENU (Overlay) - M·∫∑c ƒë·ªãnh ·∫©n (opacity: 0)
    BoxLayout:
        id: menu_overlay
        orientation: 'vertical'
        size_hint: (0.9, 0.8)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        padding: 20
        spacing: 20
        opacity: 0 
        disabled: True # Kh√¥ng b·∫•m ƒë∆∞·ª£c khi ·∫©n
        
        canvas.before:
            Color:
                rgba: (0, 0, 0, 0.9) # N·ªÅn ƒëen m·ªù che bong b√≥ng
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [20,]

        Label:
            text: "B·∫¢NG ƒêI·ªÄU KHI·ªÇN TH·ª¶ C√îNG"
            font_size: '24sp'
            bold: True
            size_hint_y: 0.15
            color: c_primary

        GridLayout:
            cols: 2
            spacing: 15
            size_hint_y: 0.7

            DashboardCard:
                title: "AN NINH"
                desc: "Camera gi√°m s√°t"
                card_color: (0.1, 0.2, 0.4, 1)
                on_release: app.root.current = 'security'

            DashboardCard:
                title: "H·ªåC T·∫¨P"
                desc: "Gia s∆∞ Ti·∫øng Anh"
                card_color: (0.25, 0.1, 0.35, 1)
                on_release: app.root.current = 'tutor'

            DashboardCard:
                title: "T√ÇM S·ª∞"
                desc: "Tr√≤ chuy·ªán ng∆∞·ªùi cao tu·ªïi"
                card_color: (0.05, 0.35, 0.35, 1)
                on_release: app.root.current = 'elderly'

            # N√∫t THO√ÅT ·ª®NG D·ª§NG (Theo y√™u c·∫ßu: Chuy·ªÉn v·ªÅ bong b√≥ng)
            DashboardCard:
                title: "THO√ÅT RA"
                desc: "ƒê√≥ng Menu, v·ªÅ Bong b√≥ng"
                card_color: (0.4, 0.1, 0.1, 1)
                on_release: root.close_menu() 

        # N√∫t tho√°t app th·∫≠t s·ª± (n·∫øu c·∫ßn)
        Button:
            text: "T·∫Øt ngu·ªìn h·ªá th·ªëng"
            size_hint_y: 0.1
            background_color: (1, 0, 0, 0.5)
            on_release: root.quit_app()

# ================= SECURITY SCREEN =================
<SecurityScreen>:
    name: 'security'
    canvas.before:
        Color:
            rgba: c_bg
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10

        # HEADER
        BoxLayout:
            size_hint_y: 0.08
            Button:
                text: "< HOME"
                size_hint_x: 0.15
                background_color: (0.1, 0.2, 0.4, 1)
                on_release: app.root.current = 'home'
            
            # --- N√öT CHUY·ªÇN CAMERA M·ªöI ---
            Button:
                text: "ƒê·ªîI CAMERA"
                size_hint_x: 0.2
                background_color: (0, 0.6, 0.8, 1) # M√†u xanh d∆∞∆°ng
                on_release: root.change_camera_source() # G·ªçi h√†m ·ªü class SecurityScreen (Python)
                
            # --- [TH√äM M·ªöI] N√öT B·∫¨T/T·∫ÆT CAMERA ---
            Button:
                id: btn_cam_toggle
                text: "T·∫ÆT CAMERA" # M·∫∑c ƒë·ªãnh l√† ƒëang b·∫≠t
                size_hint_x: 0.2
                background_color: (1, 0, 0, 1) # M√†u ƒë·ªè (b√°o hi·ªáu ƒëang quay)
                on_release: root.toggle_camera() 
            # -------------------------------------
            Label:
                text: "CAMERA MONITOR & AI CHAT"
                bold: True
                color: c_primary

        # BODY
        BoxLayout:
            orientation: 'horizontal'
            spacing: 10

            # 1. CAMERA (ƒê√£ s·ª≠a l·ªói Line)
            BoxLayout:
                size_hint_x: 0.65
                canvas.before:
                    Color:
                        rgba: (0.25, 0.1, 0.35, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                    # Vi·ªÅn xanh
                    Color:
                        rgba: c_primary
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)
                        width: 1.5
                Image:
                    id: img_camera
                    allow_stretch: True
                    keep_ratio: True

            # 2. KHUNG CHAT
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.35
                spacing: 10
                padding: 5
                
                Label:
                    text: "NH·∫¨T K√ù H·ªòI THO·∫†I"
                    size_hint_y: 0.05
                    bold: True
                
                ScrollView:
                    size_hint_y: 0.7
                    canvas.before:
                        Color:
                            rgba: (0.05, 0.35, 0.35, 1)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        id: lbl_chat_log
                        text: "System: S·∫µn s√†ng...\n"
                        size_hint_y: None
                        height: self.texture_size[1]
                        text_size: self.width, None
                        halign: 'left'
                        valign: 'top'
                        padding: [10, 10]
                        markup: True

                ModernButton:
                    id: btn_talk
                    text: "B·∫§M ƒê·ªÇ N√ìI"
                    size_hint_y: 0.15
                    background_color: (0.25, 0.1, 0.35, 1)
                    on_release: root.start_intercom()
                
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 0.1
                    spacing: 5
                    
                    TextInput:
                        id: txt_ip_suffix
                        hint_text: "3 s·ªë cu·ªëi (vd: 176)"
                        multiline: False
                        #input_filter: 'int' # Ch·ªâ cho ph√©p nh·∫≠p s·ªë
                        size_hint_x: 0.6
                        font_size: '18sp'
                        halign: 'center'

                    ModernButton:
                        text: "ƒê·ªîI IP"
                        size_hint_x: 0.4
                        background_color: (1, 0.8, 0, 1) # M√†u v√†ng cam
                        on_release: root.update_camera_ip(txt_ip_suffix.text)
                    
                    ModernButton:
                        text: "D√í IP T·ª∞ ƒê·ªòNG"
                        size_hint_x: 0.5
                        background_color: (0, 0.8, 0.4, 1) # M√†u xanh l√° ƒë·∫≠m
                        on_release: root.auto_fix_camera_connection() # G·ªçi h√†m v·ª´a th√™m ·ªü tr√™n

                # --- PH·∫¶N TH√äM M·ªöI: ƒêƒÇNG K√ù NG∆Ø·ªúI NH√Ä ---
                # Trong ph·∫ßn ƒêƒÉng k√Ω ng∆∞·ªùi nh√† c·ªßa SecurityScreen
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: 0.25  # TƒÉng di·ªán t√≠ch khu v·ª±c n√†y ƒë·ªÉ d·ªÖ ch·∫°m
                    spacing: 10
                    
                    # Trong file views/layout.kv
                    TextInput:
                        id: txt_member_name
                        hint_text: "Ch·∫°m v√†o ƒë√¢y ƒë·ªÉ nh·∫≠p t√™n..."
                        multiline: False
                        font_size: '20sp'
                        size_hint_y: 0.4
                        input_type: 'text'
                        # Th√™m d√≤ng n√†y ƒë·ªÉ h·ªó tr·ª£ t·ªët h∆°n cho c·∫£m ·ª©ng
                        keyboard_suggestions: True

                    BoxLayout:
                        size_hint_y: 0.6
                        spacing: 10
                        ModernButton:
                            text: "X√ìA CH·ªÆ"
                            background_color: (0.7, 0.7, 0.7, 1)
                            on_release: txt_member_name.text = "" # N√∫t x√≥a nhanh b·∫±ng tay
                        
                        ModernButton:
                            id: btn_register
                            text: "ƒêƒÇNG K√ù"
                            background_color: (0.25, 0.1, 0.35, 1)
                            on_release: root.register_member()

                ModernButton:
                    text: "XEM L·ªäCH S·ª¨ X√ÇM NH·∫¨P"
                    size_hint_y: 0.1
                    background_color: (1, 0.5, 0, 1)
                    on_release: root.show_gallery()

<TutorScreen>:
    name: 'tutor'
    canvas.before:
        Color:
            rgba: c_bg
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 10

        # --- HEADER & N√öT BACK ---
        BoxLayout:
            size_hint_y: 0.1
            Button:
                text: "HOME"
                size_hint_x: 0.2
                background_color: (0.3, 0.3, 0.3, 1)
                on_release: root.go_back()
            Label:
                text: "ENGLISH TUTOR (A1 - C2)"
                bold: True
                font_size: '24sp'
                color: c_primary

        # --- THANH CH·ªåN LEVEL (GRID BUTTONS) ---
        GridLayout:
            cols: 6
            size_hint_y: 0.1
            spacing: 5
            
            Button:
                text: "A1"
                background_color: (0, 0.8, 0, 1) # Xanh l√°
                on_release: root.select_level("A1")
            Button:
                text: "A2"
                background_color: (0.2, 0.8, 0, 1)
                on_release: root.select_level("A2")
            Button:
                text: "B1"
                background_color: (0.8, 0.8, 0, 1) # V√†ng
                on_release: root.select_level("B1")
            Button:
                text: "B2"
                background_color: (1, 0.6, 0, 1) # Cam
                on_release: root.select_level("B2")
            Button:
                text: "C1"
                background_color: (1, 0, 0, 1) # ƒê·ªè
                on_release: root.select_level("C1")
            Button:
                text: "C2"
                background_color: (0.5, 0, 0.5, 1) # T√≠m
                on_release: root.select_level("C2")

        # --- KHUNG HI·ªÇN TH·ªä CHAT ---
        BoxLayout:
            size_hint_y: 0.6
            canvas.before:
                Color:
                    rgba: (0.1, 0.1, 0.15, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [15,]
            
            ScrollView:
                padding: 10
                Label:
                    id: lbl_tutor_log
                    text: "H√£y ch·ªçn c·∫•p ƒë·ªô ƒë·ªÉ b·∫Øt ƒë·∫ßu...\n"
                    size_hint_y: None
                    height: self.texture_size[1]
                    text_size: self.width, None
                    halign: 'left'
                    valign: 'top'
                    markup: True
                    font_size: '18sp'
                    padding: [20, 20]

        # --- N√öT B·∫§M N√ìI ---
        ModernButton:
            text: "üéôÔ∏è B·∫§M ƒê·ªÇ TR√í CHUY·ªÜN"
            size_hint_y: 0.2
            background_color: c_primary
            on_release: root.start_voice_chat()

<ElderlyScreen>:
    name: 'elderly'
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 15
        
        BoxLayout:
            size_hint_y: 0.1
            spacing: 10
            Button:
                text: "< QUAY L·∫†I"
                on_release: root.go_back()
            
            # --- N√öT CH·ªàNH C·ª† CH·ªÆ ---
            Button:
                text: "Ch·ªØ A-"
                size_hint_x: 0.2
                on_release: root.adjust_font(-2)
            Button:
                text: "Ch·ªØ A+"
                size_hint_x: 0.2
                on_release: root.adjust_font(2)

        Label:
            text: "NG∆Ø·ªúI B·∫†N T√ÇM GIAO"
            font_size: '28sp'
            bold: True
            size_hint_y: 0.1

        ScrollView:
            canvas.before:
                Color:
                    rgba: (0.1, 0.1, 0.15, 1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                id: lbl_elderly_log
                text: "" 
                font_size: '18sp' # K√≠ch c·ª° ban ƒë·∫ßu 
                size_hint_y: None
                height: self.texture_size[1] 
                text_size: self.width, None
                markup: True 
                padding: [20, 20]

        ModernButton:
            id: btn_talk
            text: "üéôÔ∏è B·∫§M ƒê·ªÇ N√ìI CHUY·ªÜN"
            size_hint_y: 0.2
            on_release: root.toggle_voice_chat()